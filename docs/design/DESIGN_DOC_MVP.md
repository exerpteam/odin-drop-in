**Project: ODIN Web Drop-in Component - MVP Implementation**

**1. Overview & Goal**

The primary goal is to create the foundational codebase and initial functionality for a reusable, framework-agnostic JavaScript "Drop-in" UI component library for ODIN Payments. This component will allow Exerp's customers to securely capture payment details within their own web applications, similar in concept to Adyen's Web Drop-in.

This MVP focuses _exclusively_ on:

- Setting up the recommended project structure and tooling (monorepo).
- Implementing the core drop-in component using the chosen technology stack.
- Integrating ODIN's `OdinPay.js` library for **one-time Credit Card payment detail capture only**.
- Establishing clear communication (input configuration and output callbacks) between the drop-in and its host application.
- Creating a local development and testing workflow.

**Future features** (ACH, payment agreement management, $0 auth, etc.) are **out of scope** for this initial task but the architecture should facilitate their later addition.

**2. Core Technology & Tooling Stack**

The project **must** use the following technology stack:

- **Component Compiler:** **Stencil.js** - To build standard Web Components from TypeScript/JSX.
- **Language:** **TypeScript** - For all component logic and API definitions.
- **Build Tool (Library Bundling):** **Vite** (in Library Mode) - To generate the final distributable bundles (ESM, UMD, CJS).
- **Monorepo Manager:** **Turborepo** - For managing the workspace, build caching, and task orchestration.
- **Package Manager:** **pnpm** - For dependency management and leveraging workspaces with Turborepo.

**3. Project Setup & Boilerplate Requirements**

The developer must perform the following setup tasks:

- **Initialize Monorepo:** Set up a new monorepo using Turborepo and pnpm workspaces.
  - Follow Turborepo documentation for initialization (`npx create-turbo@latest`).
  - Ensure pnpm is configured as the package manager.
  - Configure `stencil.config.ts` for library output, targeting Web Components (`dist`, `dist-custom-elements`). Disable Shadow DOM initially (`shadow: false`).
  - üßë‚Äçüíª **Note:** While the final library doesn't strictly need the `www` output target, adding a minimal `www` configuration (e.g., `{ type: 'www', indexHtml: 'index.html', serviceWorker: null }`) might be necessary in `stencil.config.ts` for the Stencil development server (`pnpm start` within the core package) to correctly serve the `src/index.html` test page during isolated component development.
- **Create Facade Package:** Inside `packages/`, create the main publishable package (e.g., `packages/odin-dropin`).
  - This package will act as the public API facade. Its `src/index.ts` will import necessary elements from `@odin-payments/core` (or your chosen name) and expose the public `OdinDropin` class/functions.
  - Initialize `package.json` and `tsconfig.json`.
- **Configure Build:** Set up Vite within the `packages/odin-dropin` package to bundle the facade and necessary Stencil runtime/loaders into ESM, UMD (`OdinDropin` global name), and CJS formats. Ensure Vite correctly handles dependencies on `@odin-payments/core`.
  - Configure Vite to generate TypeScript declaration files (`.d.ts`) using `vite-plugin-dts`.
  - Ensure CSS generated by Stencil for its components is handled appropriately. (üßë‚Äçüíª _Note: In our current implementation, Stencil components manage their own CSS internally. With `shadow: false`, these styles are applied directly to the document. The facade package, `@exerp/odin-dropin`, does not extract or re-bundle these styles into a separate CSS file via its Vite configuration. Host applications can style the component using standard CSS selectors targeting elements within the component, as demonstrated by the demo app._)-
-  **Configure Root:** Set up the root `package.json`, `turbo.json`, and `tsconfig.base.json` for the monorepo, defining workspaces and base build/dev scripts managed by Turborepo.

**4. ODIN Drop-in Component Implementation (MVP - One-Time CC Payment)**

Implement the initial ODIN Drop-in functionality within the `@exerp/odin-dropin-core` Stencil package. This core package produces standard Web Components. The `@exerp/odin-dropin` facade package then consumes these components by directly importing their JavaScript definitions (from the `dist-custom-elements` output of the core package). This approach ensures that the web components are defined when the facade is used, simplifying integration into host applications.

- **Public API (`@exerp/odin-dropin`):**
  - Expose a primary class (e.g., `OdinDropin`) for initialization and mounting.
    -   üßë‚Äçüíª This class directly creates instances of the Stencil web components (e.g., `document.createElement('exerp-odin-cc-form')`) after they have been defined via module import.
  - **Initialization:** Must accept a configuration object with at least:
    - `odinPublicToken` (string): The short-lived public token obtained from the ODIN backend (the _host application_ will fetch this and pass it in).
    - `isSingleUse` (boolean, default: `true`): Indicates if the payment method token generated should be treated as single-use (`true`) or intended for saving (`false`).
    - `config` (object, optional): Configuration options. For the MVP, this can include:
          - `theme` (object, optional): A simplified theme object defined by the Drop-in API to allow basic customization (e.g., `{ primaryColor: '#...', fontBase: '...' }`). See below for internal handling. üé® (**Note:** Theme pass-through implementation deferred post-MVP).
  - **Mounting:** Provide a `mount(selector: string | HTMLElement)` method that targets a DOM element where the drop-in UI (the Stencil component) will be rendered.
  - **Callbacks:** The configuration object must accept _at least_ the following callback functions provided by the host application:
    - `onSubmit(result: { paymentMethodId: string, /* other relevant state? */ })`: Called when `OdinPay.js` (via the Stencil component) successfully returns a `paymentMethodId`.
    - `onError(error: { code: string, message?: string, /* ... */ })`: Called when `OdinPay.js` or the Stencil component encounters an error.

- **Internal Logic (`@exerp/odin-dropin-core` - Stencil Components):**
  - The core Stencil component(s) (e.g., `exerp-odin-cc-form`) must:
    - Receive the `odinPublicToken`, `isSingleUse`, and other configuration via props from the facade. (**Note:** `theme` prop deferred post-MVP).
    - Dynamically load the external `OdinPay.js` library...
    - Import and instantiate the official `OdinPay` library using the provided `odinPublicToken`. Basic theming options from the CodePen examples should be supported via the `config` passed to `OdinPay`. (**Note:** Currently uses a hardcoded theme; passing theme from props deferred post-MVP).
    - Translate the simplified `theme` object (if provided in the `config`) into the specific nested `theme` structure expected by the `OdinPay(..., { theme: { ... } })` initialization call. The MVP might only support translating a few key properties (e.g., basic font size, error color). üé® (**Note:** Theme translation deferred post-MVP).

**5. Testing & Development Workflow**

- **Local Demo:** Create a simple HTML/JS demo application within the monorepo (e.g., `apps/demo`).
  - This demo app must consume the `@odin-payments/odin-dropin` package locally using pnpm workspaces.
  - Include a script (e.g., `pnpm dev` within `apps/demo`) to serve this demo page locally using Vite or a similar simple server.
  - The demo page must provide:
    - An input field to paste a test `odinPublicToken`.
    - A button to initialize and mount the ODIN Drop-in component into a designated `div`.
    - Implement simple `onSubmit` and `onError` callbacks that log the received data/error to the browser console.
  - This setup allows the developer to visually test the drop-in component and its basic host communication during development.

**6. Initial Documentation**

- Create a `README.md` file in the root of the monorepo.
- Create a `README.md` file within the `packages/odin-dropin` package.
- This initial documentation must cover:
  - Project overview and purpose (MVP scope).
  - Instructions on how to install dependencies (`pnpm install`).
  - Instructions on how to build the library (`pnpm turbo build`).
  - Instructions on how to run the local demo application (`pnpm dev --filter=demo`).
  - A basic usage example showing how to import, configure (with callbacks), and mount the drop-in in plain JavaScript.

**7. Deliverables**

- A functional monorepo project structure managed by Turborepo and pnpm.
- A Stencil.js component package (`@odin-payments/core` or similar) implementing the basic CC capture UI wrapping `OdinPay.js`.
- A facade package (`@odin-payments/odin-dropin`) exposing the public API.
- Vite build configuration generating ESM, UMD, and CJS bundles for the facade package, including `.d.ts` files.
- A working local demo application (`apps/demo`) for testing the drop-in.
- Initial `README.md` files as specified.
- The codebase must be written in TypeScript and adhere to standard linting practices (configure ESLint/Prettier).

**8. Post-MVP Enhancements (Implemented)**

Immediately following the completion of the MVP scope defined above, the following key enhancements were implemented:

*   **Mandatory Country Code:** The component now requires a `countryCode` ('US' or 'CA') during initialization, ensuring correct regional configuration for `OdinPay.js`.
*   **"Name on Card" Field:** Support for optionally displaying the "Name on Card" field was added via the `billingFieldsConfig.name` parameter.

Refer to the [Feature Backlog](../../planning/FEATURE_BACKLOG.md) and [System Overview](../SYSTEM_OVERVIEW.md) for details on these and other ongoing developments.
