# Exerp ODIN Payment Drop-in Facade (`@exerp/odin-dropin`)

This package provides the public facade for integrating the Exerp ODIN Payment Drop-in component into web applications. It simplifies the interaction with the underlying Stencil web components and the `OdinPay.js` library.

## Installation

```bash
# Using pnpm
pnpm add @exerp/odin-dropin

# Using npm
npm install @exerp/odin-dropin

# Using yarn
yarn add @exerp/odin-dropin
```

## API Documentation

The primary export of this package is the `OdinDropin` class.

### Importing

```javascript
// ES Module import
import { OdinDropin } from '@exerp/odin-dropin';

// For UMD builds (if included via <script> tag),
// it should be available as a global variable `OdinDropin`.
// const odinDropinInstance = new window.OdinDropin({...});
```

### `new OdinDropin(params)`

Initializes a new instance of the ODIN Drop-in controller.

**Parameters:**

*   `params` (`OdinDropinInitializationParams`, **Required**): An object containing configuration parameters:
    *   `odinPublicToken` (`string`, **Required**): The short-lived public token obtained securely from your backend (which fetches it from the ODIN `/auth2/public-token` endpoint). This token is used to authenticate and initialize the underlying `OdinPay.js` library.
    *   `isSingleUse` (`boolean`, *Optional*, Default: `true`): Controls how the generated payment method token should be treated.
        *   `true`: Intended for a one-time payment.
        *   `false`: Intended for saving the payment method (e.g., for future Card-on-File or recurring payments).
    *   `onSubmit` (`(result: { paymentMethodId: string }) => void`, **Required**): A callback function that will be invoked when the user successfully submits the payment form and `OdinPay.js` returns a payment method token.
        *   **Payload:** An object containing:
            *   `paymentMethodId` (`string`): The tokenized payment method identifier generated by ODIN. Send this ID to your backend server to perform payment actions (create payment intent, save payment method, etc.).
    *   `onError` (`(error: OdinPayErrorPayload) => void`, **Required**): A callback function invoked if an error occurs during the `OdinPay.js` submission process, during the initialization of `OdinPay.js`, or if an internal setup error occurs within the drop-in component.
        *   **Payload (`OdinPayErrorPayload`):** An object containing:
            *   `code` (`string`): An error code string indicating the nature of the error. Examples:
                *   `INIT_NO_KEY_PROVIDED`, `INIT_BADLY_FORMATTED_KEY`, `INIT_INVALID_KEY_STRUCTURE`, `INIT_UNSUPPORTED_COUNTRY`, `INIT_BT_SDK_FAILURE`: Errors during OdinPay.js initialization.
                *   `VALIDATION_ERROR_FIELDS`: Input validation failed for specific fields. See `fieldErrors`.
                *   `VALIDATION_ERROR_GENERAL`: General input validation failure. See `fieldErrors` (may contain entries with `field: "general[n]"`).
                *   `API_AUTH_ERROR`: An authentication error with the ODIN API (e.g., HTTP 401, often due to an expired or invalid public token).
                *   `API_CLIENT_ERROR`: A client-side error with the ODIN API (e.g., HTTP 4xx).
                *   `API_SERVER_ERROR`: A server-side error with the ODIN API (e.g., HTTP 5xx).
                *   `GENERAL_PAYMENT_ERROR`: A generic error during payment processing not covered by other codes.
                *   `ODIN_CALLBACK_ERROR`: A generic error originating from the OdinPay.js callback that couldn't be further categorized.
                *   `UNEXPECTED_CALLBACK_STRUCTURE`: The structure of the callback from OdinPay.js was not as expected.
                *   `MOUNT_POINT_NOT_FOUND`: The DOM element for mounting the drop-in was not found.
                *   `COMPONENT_CREATION_FAILED`: The Stencil web component could not be created.
                *   `SDK_LOAD_ERROR`: The OdinPay.js SDK failed to load.
                *   `UNKNOWN_ERROR`: An error occurred that could not be identified.
            *   `message` (`string`): A human-readable description of the error. For validation errors with `fieldErrors`, this might be a general summary. For API errors, it often contains the direct message from OdinPay.js.
            *   `fieldErrors?` (`Array<{ field: string, message: string }>`, *Optional*): An array of objects detailing field-specific validation errors. Each object contains:
                *   `field` (`string`): The name of the input field that failed validation (e.g., `"card"`, `"postalCode"`, `"name"`) or a generic identifier (e.g., `"general[0]"`) for errors not tied to a specific input.
                *   `message` (`string`): The validation error message for that specific field.
            *   `httpStatusCode?` (`number`, *Optional*): The HTTP status code if the error originated from an API call (e.g., `401`, `400`, `500`).
    *   `config` (`object`, *Optional*): A placeholder for future configuration options. Currently unused or for internal configuration (e.g., passing a simplified theme object to the core component - *Note: Theme pass-through not yet fully implemented*).

### `instance.mount(selectorOrElement)`

Mounts the ODIN Drop-in UI component into the specified DOM element.

**Parameters:**

*   `selectorOrElement` (`string | HTMLElement`, **Required**):
    *   If a string, it should be a CSS selector (e.g., `'#my-odin-container'`) pointing to the container element where the drop-in should be rendered.
    *   If an `HTMLElement`, it's the direct reference to the container element.
*   **Returns:** `void`

### `instance.unmount()`

Removes the ODIN Drop-in UI component from the DOM and cleans up associated event listeners.

*   **Parameters:** None
*   **Returns:** `void`

## Usage Example

```html
<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Odin Drop-in Test</title>
    <style>
        /* Basic button styling for this example */
        .odin-submit-button { /* Target class from internal component */
            padding: 10px 15px; background-color: #007bff; color: white;
            border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;
        }
        .odin-submit-button:disabled { opacity: 0.6; cursor: not-allowed; }
        #odin-container { max-width: 400px; padding: 20px; border: 1px solid #ccc; margin: 20px; min-height: 150px; }
        .error-message { color: red; margin-top: 10px; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>Odin Payment Form Example</h1>
    <div id="odin-container">
        <!-- Drop-in will mount here -->
    </div>
    <div id="result-display"></div>
    <div id="error-display" class="error-message"></div>

    <script type="module" src="app.js"></script>
</body>
</html>
```

```javascript
// app.js
import { OdinDropin } from '@exerp/odin-dropin';

const odinContainer = document.getElementById('odin-container');
const resultDisplay = document.getElementById('result-display');
const errorDisplay = document.getElementById('error-display');
let odinDropinInstance = null; // To hold the instance

// --- Fetch Public Token (Replace with your actual backend call) ---
async function getPublicToken() {
    // Simulate fetching from backend
    console.log("Fetching ODIN Public Token...");
    // In a real app, replace this with:
    // const response = await fetch('/api/get-odin-public-token');
    // if (!response.ok) throw new Error('Failed to fetch token');
    // const data = await response.json();
    // return data.publicToken;
    // For example purposes:
    return prompt("Enter ODIN Public Token:"); // DO NOT use prompt in production
}

// --- Initialize and Mount ---
async function initializeOdin() {
    if (!odinContainer) {
        console.error('Mount point not found');
        return;
    }

    try {
        const token = await getPublicToken();
        if (!token) {
            throw new Error('ODIN Public Token is required.');
        }

        // Clean previous state if re-initializing
        if (odinDropinInstance) {
            odinDropinInstance.unmount();
        }
        if (resultDisplay) resultDisplay.textContent = '';
        if (errorDisplay) errorDisplay.textContent = '';

        odinDropinInstance = new OdinDropin({
            odinPublicToken: token,
            isSingleUse: true, // Example: one-time payment

            onSubmit: (result) => {
                console.log('onSubmit received:', result);
                if (resultDisplay) resultDisplay.textContent = `Success! PM ID: ${result.paymentMethodId}`;
                if (errorDisplay) errorDisplay.textContent = '';
                // SEND result.paymentMethodId TO YOUR BACKEND HERE
                alert(`Payment Method ID: ${result.paymentMethodId} - Send this to backend.`);
                // Optionally unmount after success:
                // odinDropinInstance.unmount();
            },
            onError: (error) => {
                console.error('onError received:', error);
                if (errorDisplay) errorDisplay.textContent = `Error: ${error.message}`;
                if (resultDisplay) resultDisplay.textContent = '';
            },
        });

        odinDropinInstance.mount(odinContainer); // Mount into the div element

    } catch (error) {
        console.error('Initialization or mounting failed:', error);
        if (errorDisplay) errorDisplay.textContent = `Error: ${error.message || error}`;
    }
}

// --- Run Initialization ---
initializeOdin();

// Example of how to unmount if needed later (e.g., on component destroy in a framework)
// function cleanup() {
//   if (odinDropinInstance) {
//     odinDropinInstance.unmount();
//     odinDropinInstance = null;
//     console.log('Odin Drop-in unmounted.');
//   }
// }
// window.addEventListener('beforeunload', cleanup); // Example cleanup trigger
